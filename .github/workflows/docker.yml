name: Docker Build and Push with JFrog CLI

on:
  push:
    branches: [ "master","main" ]

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      OIDC_PROVIDER: 'test'
      OIDC_AUDIENCE: 'test'
      POC_URL: 'https://demo.jfrogchina.com'
      # 定义镜像标签
      DOCKER_IMAGE_NAME: 'zhl-docker-ali-remote/library/nginx'
      DOCKER_IMAGE_TAG: 'latest'

    steps:
    # 步骤1 & 2: 获取并交换 OIDC 令牌 (与你原流程一致)
    - name: Get id token
      run: |
        ID_TOKEN=$(curl -sLS -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
        "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${OIDC_AUDIENCE}" | jq .value | tr -d '"')
        echo "ID_TOKEN=${ID_TOKEN}" >> $GITHUB_ENV

    - name: Exchange token with access
      env:
        ID_TOKEN: ${{env.ID_TOKEN}}
        JFROG_PLATFORM_URL: https://demo.jfrogchina.com/artifactory/api/oauth2/loginResponse
      run: |
        ACCESS_TOKEN=$(curl -XPOST -H "Content-Type: application/json" "${{ env.POC_URL }}/access/api/v1/oidc/token" -d "{\"grant_type\": \"urn:ietf:params:oauth:grant-type:token-exchange\", \"subject_token_type\":\"urn:ietf:params:oauth:token-type:id_token\", \"subject_token\": \"${ID_TOKEN}\", \"provider_name\": \"${OIDC_PROVIDER}\"}" | jq .access_token | tr -d '"' )
        echo "ACCESS_TOKEN=${ACCESS_TOKEN}" >> $GITHUB_ENV
        # 将访问令牌设置为GitHub Secret，避免在日志中暴露
        echo "===ID_TOKEN: ${ID_TOKEN}"
        echo "===ACCESS_TOKEN: ${ACCESS_TOKEN}"
        echo "=== OIDC_PROVIDER: ${OIDC_PROVIDER}"
        echo "JF_ACCESS_TOKEN=${ACCESS_TOKEN}" >> $GITHUB_ENV
        printenv


    - uses: actions/checkout@v4

    # 步骤3: 安装并配置 JFrog CLI
    - name: Setup JFrog CLI
      uses: jfrog/setup-jfrog-cli@v4
      env:
        JF_URL_NAME: ${{ env.POC_URL }}
        JF_ACCESS_TOKEN: ${{ env.JF_ACCESS_TOKEN }} # 使用经过交换得到的访问令牌
      with:
        version: latest

    - name: Configure JFrog CLI
      run: |
        jfrog config add my-artifactory --url ${JF_URL_NAME} --access-token ${JF_ACCESS_TOKEN} --interactive=false
        jfrog config show my-artifactory
        

    # # 步骤4: 构建 Docker 镜像
    # - name: Build Docker image
    #   run: |
    #     docker build -t ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} .

    # # 步骤5: 使用 JFrog CLI 推送镜像并捕获构建信息
    # - name: Push Docker image to Artifactory
    #   run: |
    #     # 使用 jfrog rt docker-push 命令推送镜像，此命令专为Docker镜像设计[citation:9]
    #     jfrog rt docker-push \
    #       ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
    #       your-docker-local-repo \
    #       --build-name=my-docker-build \
    #       --build-number=${{ github.run_id }}

    # # 步骤6: 收集并发布构建信息
    # - name: Publish build info
    #   run: |
    #     jfrog rt bce my-docker-build ${{ github.run_id }} # 收集环境变量等信息[citation:3]
    #     jfrog rt bp my-docker-build ${{ github.run_id }} # 将构建信息发布到Artifactory[citation:3]

    # 步骤7: (可选) 从 Artifactory 拉取镜像示例
    - name: Pull Docker image from Artifactory
      run: |
        # 使用 jfrog rt docker-pull 命令拉取镜像[citation:1]
        jfrog rt docker-pull \
          ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
          your-docker-local-repo
